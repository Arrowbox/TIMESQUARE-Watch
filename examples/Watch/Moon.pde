PROGMEM uint8_t phases[] = {
  0x03,0x01,0x00,0x00,0x04,0x02,0x00,0x00,0x04,0x04,0x01,0x00,0x05,0x0B,0x02,0x00,
  0x06,0x25,0x03,0x00,0x0C,0x55,0x03,0x00,0x31,0x6A,0x03,0x00,0x9C,0x6A,0x03,0x00,
  0xEB,0x6A,0x03,0x00,0xEB,0x66,0x02,0x00,0xE6,0x56,0x01,0x00,0xDF,0x3A,0x00,0x00,
  0xD1,0x16,0x00,0x00,0xAE,0x04,0x00,0x00,0x51,0x01,0x00,0x00,0x0F,0x01,0x00,0x00,
  0x00,0x00,0x02,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x0B,0x02,0x00,0x00,0x34,0x03,
  0x00,0x01,0xAC,0x03,0x00,0x27,0xDF,0x03,0x00,0xFA,0xDF,0x03,0x63,0xFF,0xDF,0x03,
  0xFF,0xFF,0xDF,0x03,0xFF,0xFF,0xD1,0x01,0xFF,0xFF,0xA2,0x00,0xFF,0xFF,0x42,0x00,
  0xFF,0xED,0x09,0x00,0xFF,0x48,0x02,0x00,0xE1,0x01,0x02,0x00,0x0F,0x00,0x02,0x00,
  0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x1B,0x00,0x00,0x01,0x61,
  0x00,0x00,0x35,0x6A,0x00,0x03,0xFF,0x6A,0x00,0xB4,0xFF,0x6A,0x4D,0xFF,0xFF,0x6A,
  0xFF,0xFF,0xFF,0x6A,0xFF,0xFF,0xFF,0x50,0xFF,0xFF,0xFF,0x1F,0xFF,0xFF,0xEB,0x02,
  0xFF,0xFF,0x38,0x01,0xFF,0xA8,0x00,0x01,0xFF,0x02,0x00,0x01,0x16,0x00,0x00,0x01,
  0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x26,0x00,0x00,0x00,0x94,
  0x00,0x00,0x13,0xEB,0x00,0x00,0xFF,0xEB,0x00,0x8B,0xFF,0xEB,0x45,0xFF,0xFF,0xEB,
  0xFF,0xFF,0xFF,0xEB,0xFF,0xFF,0xFF,0xC1,0xFF,0xFF,0xFF,0x60,0xFF,0xFF,0xFF,0x11,
  0xFF,0xFF,0x59,0x03,0xFF,0xF2,0x00,0x03,0xFF,0x05,0x00,0x03,0x1A,0x00,0x00,0x03,
  0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x26,0x00,0x00,0x00,0x94,
  0x00,0x00,0x13,0xEB,0x00,0x00,0xFF,0xEB,0x00,0x8B,0xFF,0xEB,0x45,0xFF,0xFF,0xEB,
  0xFF,0xFF,0xFF,0xEB,0xFF,0xFF,0xFF,0xC1,0xFF,0xFF,0xFF,0x60,0xFF,0xFF,0xFF,0x11,
  0xFF,0xFF,0x59,0x03,0xFF,0xF2,0x00,0x03,0xFF,0x05,0x00,0x03,0x1A,0x00,0x00,0x03,
  0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x1B,0x00,0x00,0x01,0x61,
  0x00,0x00,0x35,0x6A,0x00,0x03,0xFF,0x6A,0x00,0xB4,0xFF,0x6A,0x4D,0xFF,0xFF,0x6A,
  0xFF,0xFF,0xFF,0x6A,0xFF,0xFF,0xFF,0x50,0xFF,0xFF,0xFF,0x1F,0xFF,0xFF,0xEB,0x02,
  0xFF,0xFF,0x38,0x01,0xFF,0xA8,0x00,0x01,0xFF,0x02,0x00,0x01,0x16,0x00,0x00,0x01,
  0x00,0x00,0x02,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x0B,0x02,0x00,0x00,0x35,0x03,
  0x00,0x01,0xAC,0x03,0x00,0x27,0xDF,0x03,0x00,0xFA,0xDF,0x03,0x63,0xFF,0xDF,0x03,
  0xFF,0xFF,0xDF,0x03,0xFF,0xFF,0xD1,0x01,0xFF,0xFF,0xA2,0x00,0xFF,0xFF,0x42,0x00,
  0xFF,0xED,0x09,0x00,0xFF,0x48,0x02,0x00,0xE1,0x01,0x02,0x00,0x0F,0x00,0x02,0x00,
  0x03,0x01,0x00,0x00,0x04,0x02,0x00,0x00,0x04,0x04,0x01,0x00,0x05,0x0B,0x02,0x00,
  0x06,0x25,0x03,0x00,0x0C,0x55,0x03,0x00,0x31,0x6A,0x03,0x00,0x9C,0x6A,0x03,0x00,
  0xEB,0x6A,0x03,0x00,0xEB,0x66,0x02,0x00,0xE6,0x56,0x01,0x00,0xDF,0x3A,0x00,0x00,
  0xD1,0x16,0x00,0x00,0xAE,0x04,0x00,0x00,0x51,0x01,0x00,0x00,0x0F,0x01,0x00,0x00 },
  leftHalf[]  = { 0,  0, 0, 0, 0, 0, 0, 0,  15,  14, 13, 12, 11, 10, 9,  8,  8,  8,  8,  8,  8,  8,   8,  7, 6, 5, 4, 3, 2, 1 },
  rightHalf[] = { 0,  1, 2, 3, 4, 5, 6, 7,   8,   8,  8,  8,  8,  8, 8,  8,  9, 10, 11, 12, 13, 14,  15,  0, 0, 0, 0, 0, 0, 0 };

uint8_t phase = 0;

// Time/date of a known new moon (UNIX time) - Jan 7 1970 20:35
//#define NEW_MOON (((6L * 24L + 20L) * 60L + 35L) * 60L)

// Time/date of a known new moon (UNIX time) - Dec 7 1999 22:32
#define NEW_MOON 944605920
#define LP       2551443L // Lunar period in seconds

void mode_moon(uint8_t action) {

  if(action != ACTION_NONE) {
    // If we just arrived here (whether through mode change
    // or wake from sleep), initialize the matrix driver:
    if(action >= ACTION_HOLD_LEFT) {
      uint8_t depth = 7, plex = LED_PLEX_4;
      // Reduce depth/plex if battery voltage is low
      if(watch.getmV() < 2700) {
        depth = 2;
        plex  = LED_PLEX_1;
      }
      // Reconfigure display if needed
      if((watch.getDepth() != depth) || (watch.getPlex() != plex))
        fps = watch.setDisplayMode(depth, plex, true);
        DateTime now = RTC.now();
        long nao = now.unixtime();
        phase    = (uint8_t) (((nao - NEW_MOON) % LP) / (24L * 3600L));
    }
    // Reset sleep timeout on ANY button action
    watch.setTimeout(fps * 3);
  }

  uint16_t t = watch.getTimeout();
  uint8_t  b = (t < sizeof(fade)) ? (uint8_t)pgm_read_byte(&fade[t]) : 255;

  watch.fillScreen(0);
  blit(phases, 64, 8, pgm_read_byte(&rightHalf[phase]) * 4 ,0, 4, 0, 4, 8, b );
  watch.setRotation(2);
  blit(phases, 64, 8, pgm_read_byte(&leftHalf[phase])  * 4 ,0, 4, 0, 4, 8, b );
  watch.setRotation(0);
}

